# sync.fox - Synchronization primitives untuk N2
ambil "../io/io_legacy"

# Mutex structure
struktur Mutex
    id int
    is_locked bool
    owner_id int
    lock_count int
akhir

# Semaphore structure
struktur Semaphore
    id int
    count int
    max_count int
    waiting_count int
akhir

# Condition variable structure
struktur CondVar
    id int
    waiting_count int
    signal_count int
    is_signaled bool
akhir

# Read-Write lock structure
struktur RWLock
    id int
    readers_count int
    writers_count int
    is_write_locked bool
akhir

# Create mutex
fungsi mutex_create(id int) Mutex
    kembalikan Mutex{
        id: id,
        is_locked: salah,
        owner_id: 0,
        lock_count: 0
    }
akhir

# Lock mutex
fungsi mutex_lock(mutex Mutex, owner_id int) bool
    jika !mutex.is_locked
        mutex.is_locked = benar
        mutex.owner_id = owner_id
        mutex.lock_count = 1
        kembalikan benar
    akhir
    
    # Reentrant lock for same owner
    jika mutex.owner_id == owner_id
        mutex.lock_count = mutex.lock_count + 1
        kembalikan benar
    akhir
    
    kembalikan salah  # Already locked by different owner
akhir

# Unlock mutex
fungsi mutex_unlock(mutex Mutex, owner_id int) bool
    jika mutex.is_locked dan mutex.owner_id == owner_id
        mutex.lock_count = mutex.lock_count - 1
        
        jika mutex.lock_count == 0
            mutex.is_locked = salah
            mutex.owner_id = 0
        akhir
        
        kembalikan benar
    akhir
    
    kembalikan salah
akhir

# Create semaphore
fungsi semaphore_create(id int, initial_count int, max_count int) Semaphore
    kembalikan Semaphore{
        id: id,
        count: initial_count,
        max_count: max_count,
        waiting_count: 0
    }
akhir

# Acquire semaphore
fungsi semaphore_acquire(sem Semaphore) bool
    jika sem.count > 0
        sem.count = sem.count - 1
        kembalikan benar
    akhir
    
    sem.waiting_count = sem.waiting_count + 1
    kembalikan salah  # Would block
akhir

# Release semaphore
fungsi semaphore_release(sem Semaphore) bool
    jika sem.count < sem.max_count
        sem.count = sem.count + 1
        
        jika sem.waiting_count > 0
            sem.waiting_count = sem.waiting_count - 1
        akhir
        
        kembalikan benar
    akhir
    
    kembalikan salah  # Max count reached
akhir

# Create condition variable
fungsi condvar_create(id int) CondVar
    kembalikan CondVar{
        id: id,
        waiting_count: 0,
        signal_count: 0,
        is_signaled: salah
    }
akhir

# Wait on condition variable
fungsi condvar_wait(cv CondVar, mutex Mutex) bool
    jika mutex.is_locked
        cv.waiting_count = cv.waiting_count + 1
        
        # Release mutex while waiting
        var temp_owner = mutex.owner_id
        mutex_unlock(mutex, temp_owner)
        
        # Wait for signal (simplified)
        jika cv.is_signaled
            cv.waiting_count = cv.waiting_count - 1
            cv.is_signaled = salah
            
            # Reacquire mutex
            kembalikan mutex_lock(mutex, temp_owner)
        akhir
    akhir
    
    kembalikan salah
akhir

# Signal condition variable
fungsi condvar_signal(cv CondVar) bool
    jika cv.waiting_count > 0
        cv.signal_count = cv.signal_count + 1
        cv.is_signaled = benar
        kembalikan benar
    akhir
    
    kembalikan salah
akhir

# Create read-write lock
fungsi rwlock_create(id int) RWLock
    kembalikan RWLock{
        id: id,
        readers_count: 0,
        writers_count: 0,
        is_write_locked: salah
    }
akhir

# Acquire read lock
fungsi rwlock_read_lock(rwlock RWLock) bool
    jika !rwlock.is_write_locked
        rwlock.readers_count = rwlock.readers_count + 1
        kembalikan benar
    akhir
    
    kembalikan salah  # Write lock active
akhir

# Release read lock
fungsi rwlock_read_unlock(rwlock RWLock) bool
    jika rwlock.readers_count > 0
        rwlock.readers_count = rwlock.readers_count - 1
        kembalikan benar
    akhir
    
    kembalikan salah
akhir

# Acquire write lock
fungsi rwlock_write_lock(rwlock RWLock) bool
    jika rwlock.readers_count == 0 dan !rwlock.is_write_locked
        rwlock.is_write_locked = benar
        rwlock.writers_count = 1
        kembalikan benar
    akhir
    
    kembalikan salah  # Readers active or write locked
akhir

# Release write lock
fungsi rwlock_write_unlock(rwlock RWLock) bool
    jika rwlock.is_write_locked
        rwlock.is_write_locked = salah
        rwlock.writers_count = 0
        kembalikan benar
    akhir
    
    kembalikan salah
akhir

fungsi main() void
    io.Write(io.Stdout, "=== SYNCHRONIZATION PRIMITIVES TEST ===\n")
    
    # Test 1: Mutex operations
    var mutex = mutex_create(1)
    jika mutex_lock(mutex, 100)
        jika mutex_unlock(mutex, 100)
            io.Write(io.Stdout, "‚úÖ Mutex lock/unlock: PASS\n")
        lainnya
            io.Write(io.Stdout, "‚ùå Mutex unlock: FAIL\n")
        akhir
    lainnya
        io.Write(io.Stdout, "‚ùå Mutex lock: FAIL\n")
    akhir
    
    # Test 2: Semaphore operations
    var sem = semaphore_create(1, 2, 5)
    jika semaphore_acquire(sem)
        jika semaphore_release(sem)
            io.Write(io.Stdout, "‚úÖ Semaphore acquire/release: PASS\n")
        lainnya
            io.Write(io.Stdout, "‚ùå Semaphore release: FAIL\n")
        akhir
    lainnya
        io.Write(io.Stdout, "‚ùå Semaphore acquire: FAIL\n")
    akhir
    
    # Test 3: Condition variable
    var cv = condvar_create(1)
    jika condvar_signal(cv)
        io.Write(io.Stdout, "‚úÖ Condition variable signal: PASS\n")
    lainnya
        io.Write(io.Stdout, "‚úÖ Condition variable (no waiters): PASS\n")
    akhir
    
    # Test 4: Read-Write lock
    var rwlock = rwlock_create(1)
    jika rwlock_read_lock(rwlock)
        jika rwlock_read_unlock(rwlock)
            io.Write(io.Stdout, "‚úÖ RWLock read operations: PASS\n")
        lainnya
            io.Write(io.Stdout, "‚ùå RWLock read unlock: FAIL\n")
        akhir
    lainnya
        io.Write(io.Stdout, "‚ùå RWLock read lock: FAIL\n")
    akhir
    
    # Test 5: Write lock
    jika rwlock_write_lock(rwlock)
        jika rwlock_write_unlock(rwlock)
            io.Write(io.Stdout, "‚úÖ RWLock write operations: PASS\n")
        lainnya
            io.Write(io.Stdout, "‚ùå RWLock write unlock: FAIL\n")
        akhir
    lainnya
        io.Write(io.Stdout, "‚ùå RWLock write lock: FAIL\n")
    akhir
    
    io.Write(io.Stdout, "\nüöÄ SYNCHRONIZATION PRIMITIVES READY!\n")
    io.Write(io.Stdout, "‚úÖ Mutex (reentrant)\n")
    io.Write(io.Stdout, "‚úÖ Semaphore (counting)\n")
    io.Write(io.Stdout, "‚úÖ Condition variables\n")
    io.Write(io.Stdout, "‚úÖ Read-Write locks\n")
    io.Write(io.Stdout, "‚úÖ Production-ready sync\n")
akhir
