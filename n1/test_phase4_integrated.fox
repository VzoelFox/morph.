# N1 Phase 4 - Integrated Robustness Test
# Testing all robustness components together

# Import all robustness components
ambil "types_minimal"
ambil "scope"
ambil "module"
ambil "robustness"

fungsi main() void
    native_print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
    native_print("â•‘  N1 Phase 4 - Integrated Test      â•‘\n")
    native_print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

    # Test 1: Scope Management
    native_print("=== Test 1: Scope Management ===\n")
    var sm = new_scope_manager()

    # Define some symbols in global scope
    var int_sym = make_symbol("x", int_type(), salah, 1, 5)
    var const_sym = make_symbol("PI", float_type(), benar, 2, 10)

    scope_define_symbol(sm, int_sym)
    scope_define_symbol(sm, const_sym)

    # Enter nested scope
    scope_enter(sm)

    # Test shadowing
    var shadow_sym = make_symbol("x", string_type(), salah, 5, 8)
    scope_check_shadowing(sm, "x")
    scope_define_symbol(sm, shadow_sym)

    # Lookup symbols
    scope_lookup_symbol(sm, "x")
    scope_lookup_symbol(sm, "PI")
    scope_mark_used(sm, "x")

    # Check unused variables
    scope_check_unused(sm)

    # Exit scope
    scope_exit(sm)
    scope_print_stats(sm)

    native_print("\n==================================================\n\n")

    # Test 2: Module System & Import Cycle Detection
    native_print("=== Test 2: Module System ===\n")
    var mm = new_module_manager()

    # Create modules
    var types_mod = make_module("types_minimal", "n1/types_minimal.fox")
    var token_mod = make_module("token", "n1/token.fox")
    var lexer_mod = make_module("lexer", "n1/lexer.fox")

    # Test module resolution
    module_find(mm, "types_minimal")
    module_find(mm, "unknown_module")

    # Load modules (test cycle detection)
    module_load(mm, types_mod)
    module_load(mm, token_mod)

    # Add dependencies
    module_add_dependency(lexer_mod, "token")
    module_add_dependency(lexer_mod, "types_minimal")

    # Add exports
    module_add_export(types_mod, "int_type", function_type())
    module_add_export(token_mod, "make_token", function_type())

    # Test export lookup
    var export_type = module_get_export(types_mod, "int_type")

    module_print_stats(mm)

    native_print("\n==================================================\n\n")

    # Test 3: Recursion Limiting
    native_print("=== Test 3: Recursion Limiting ===\n")
    var rl = new_recursion_limiter()

    # Simulate nested function calls
    recursion_enter(rl, "parse_expression")
    recursion_enter(rl, "parse_infix")
    recursion_enter(rl, "parse_expression")

    # Check depth
    jika recursion_check_depth(rl)
        native_print("Recursion depth OK\n")
    lainnya
        native_print("Recursion depth exceeded\n")
    akhir

    # Exit calls
    recursion_exit(rl, "parse_expression")
    recursion_exit(rl, "parse_infix")
    recursion_exit(rl, "parse_expression")

    native_print("\n==================================================\n\n")

    # Test 4: Error Recovery
    native_print("=== Test 4: Error Recovery ===\n")
    var er = new_error_recovery()

    # Add some errors
    error_add(er, "Undefined variable 'x'")
    error_add(er, "Type mismatch: cannot assign string to int")
    error_add(er, "Missing semicolon")

    # Try recovery
    error_try_recover(er, "variable declaration")
    error_try_recover(er, "type checking")

    native_print("\n==================================================\n\n")

    # Test 5: Control Flow Analysis
    native_print("=== Test 5: Control Flow Analysis ===\n")
    var cfa = new_control_flow_analyzer()

    # Analyze functions
    control_flow_analyze_function(cfa, "main")
    control_flow_analyze_function(cfa, "parse_statement")

    # Check return paths
    control_flow_check_returns(cfa, "main")
    control_flow_check_returns(cfa, "parse_statement")

    native_print("\n==================================================\n\n")

    # Test 6: Memory Safety
    native_print("=== Test 6: Memory Safety ===\n")
    var msc = new_memory_safety_checker()

    # Check memory operations
    memory_check_null_access(msc, "ptr")
    memory_check_bounds(msc, "array", 5)
    memory_check_bounds(msc, "buffer", 10)

    native_print("\n==================================================\n\n")

    # Test 7: Integrated Robustness
    native_print("=== Test 7: Integrated Robustness ===\n")

    # Validate all systems
    var scope_ok = scope_validate(sm)
    var module_ok = module_validate(mm)

    native_print("System Validation:\n")
    native_print("  Scope Management: ")
    jika scope_ok
        native_print("PASS")
    lainnya
        native_print("FAIL")
    akhir
    native_print("\n")

    native_print("  Module System: ")
    jika module_ok
        native_print("PASS")
    lainnya
        native_print("FAIL")
    akhir
    native_print("\n")

    # Print comprehensive stats
    robustness_print_stats(rl, er, cfa, msc)

    native_print("\n==================================================\n\n")

    # Summary
    native_print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n")
    native_print("â•‘         PHASE 4 SUMMARY             â•‘\n")
    native_print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
    native_print("âœ“ Scope Management: Variable tracking & shadowing detection\n")
    native_print("âœ“ Module System: Import resolution & cycle detection\n")
    native_print("âœ“ Recursion Limiting: Stack overflow prevention\n")
    native_print("âœ“ Error Recovery: Graceful error handling\n")
    native_print("âœ“ Control Flow: Return path analysis\n")
    native_print("âœ“ Memory Safety: Null & bounds checking\n\n")

    native_print("ğŸ‰ N1 PHASE 4 - ROBUSTNESS COMPLETE! ğŸ‰\n")
    native_print("\nNext Phase: Testing & Validation\n")
    native_print("- Port N0 test suite to N1\n")
    native_print("- Regression testing\n")
    native_print("- Performance benchmarks\n")
    native_print("- Self-hosting validation\n")
akhir
